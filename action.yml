# Apache License
# Version 2.0, January 2004
# Author: Jonathan Tiritilli

name: 'OpenAPI YAML Enhancement with AI'
description: 'Enhance OpenAPI YAML specifications with AI-generated descriptions for improved documentation quality'
author: 'Jonathan Tiritilli'
branding:
  icon: edit-3
  color: yellow

inputs:
  openai_api_key:
    description: 'OpenAI API key for AI processing'
    required: true
  yaml_input_path:
    description: 'Path to directory containing YAML files'
    required: false
    default: './yaml'
  yaml_output_path:
    description: 'Path to output directory for enhanced YAML files (empty for in-place enhancement)'
    required: false
    default: ''
  enhancement_mode:
    description: 'Enhancement mode: missing_only (default), improve_all, specific_fields'
    required: false
    default: 'missing_only'
  quality_threshold:
    description: 'Minimum quality score (0-100) for AI-generated descriptions'
    required: false
    default: '85'
  openai_model:
    description: 'OpenAI model to use (gpt-4o, gpt-4, gpt-3.5-turbo)'
    required: false
    default: 'gpt-4o'
  max_iterations:
    description: 'Maximum refinement iterations'
    required: false
    default: '3'
  completeness_threshold:
    description: 'Quality score threshold for completion (0-100)'
    required: false
    default: '90'
  timeout_minutes:
    description: 'Maximum processing time in minutes'
    required: false
    default: '30'
  process_changed_only:
    description: 'Only process YAML files that have changed (requires git history)'
    required: false
    default: 'false'
  changed_files:
    description: 'Newline-separated list of changed files to process (overrides internal change detection)'
    required: false
    default: ''
  base_ref:
    description: 'Base reference for change detection (default: main branch or PR base)'
    required: false
    default: ''
  create_pull_request:
    description: 'Create a pull request with enhanced YAML files'
    required: false
    default: 'false'
  pr_title:
    description: 'Title for the pull request'
    required: false
    default: 'ðŸ“ Enhance OpenAPI YAML Specifications'
  pr_branch_name:
    description: 'Name for the PR branch (uses auto-generated name if not provided)'
    required: false
    default: 'yaml/enhance-specs'

outputs:
  enhanced_yaml_path:
    description: 'Path to directory containing enhanced YAML files'
    value: ${{ steps.enhance.outputs.output_path }}
  files_enhanced:
    description: 'Number of YAML files that were enhanced'
    value: ${{ steps.enhance.outputs.files_count }}
  enhancements_total:
    description: 'Total number of descriptions added/improved'
    value: ${{ steps.enhance.outputs.enhancements_total }}

runs:
  using: composite
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r ${{ github.action_path }}/requirements.txt

    - name: Detect changed YAML files
      id: changed-yaml
      shell: bash
      run: |
        if [[ "${{ inputs.process_changed_only }}" == "true" ]]; then
          echo "ðŸ” Detecting changed YAML files..."

          # Determine base reference
          if [[ -n "${{ inputs.base_ref }}" ]]; then
            BASE_REF="${{ inputs.base_ref }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # For direct pushes to main, compare against previous commit
            BASE_REF="${{ github.event.before }}"
          else
            BASE_REF="origin/main"
          fi

          echo "Base reference: $BASE_REF"

          # Get changed YAML files
          YAML_DIR=$(echo "${{ inputs.yaml_input_path }}" | sed 's|^\./||')  # Remove leading ./
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT "$BASE_REF"...HEAD | grep -E '\.(yaml|yml)$' | grep "^${YAML_DIR}/" || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "âš ï¸ No YAML files changed in ${{ inputs.yaml_input_path }}"
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed YAML files:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'

          # Save to output
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "ðŸ—‚ï¸ Processing all YAML files in directory"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files=" >> $GITHUB_OUTPUT
        fi

    - name: Check if processing needed
      id: should-process
      shell: bash
      run: |
        # Check if there are any changes to process
        # Use external changed_files input if provided, otherwise check internal detection
        if [[ -n "${{ inputs.changed_files }}" ]]; then
          # External file list provided - always process
          echo "should_process=true" >> $GITHUB_OUTPUT
        elif [[ "${{ steps.changed-yaml.outputs.has_changes }}" != "true" ]]; then
          echo "â„¹ï¸ No changes detected, no processing needed"
          echo "## â„¹ï¸ No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No YAML files have changed since last run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action taken:** Workflow completed successfully without generating documentation." >> $GITHUB_STEP_SUMMARY
          echo "should_process=false" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "should_process=true" >> $GITHUB_OUTPUT
        fi

    - name: Prepare directories
      if: steps.should-process.outputs.should_process == 'true'
      shell: bash
      run: |
        # Create output directory if different from input
        if [[ -n "${{ inputs.yaml_output_path }}" && "${{ inputs.yaml_output_path }}" != "${{ inputs.yaml_input_path }}" ]]; then
          mkdir -p "${{ inputs.yaml_output_path }}"
          echo "ðŸ“ Output directory: ${{ inputs.yaml_output_path }}"
        else
          echo "ðŸ“ In-place enhancement mode"
        fi

        # Verify input directory exists
        if [[ ! -d "${{ inputs.yaml_input_path }}" ]]; then
          echo "âŒ Input directory not found: ${{ inputs.yaml_input_path }}"
          echo "Please ensure YAML files are in the specified directory"
          exit 1
        fi

        # Count YAML files
        YAML_COUNT=$(find "${{ inputs.yaml_input_path }}" -name "*.yaml" -o -name "*.yml" | wc -l)
        echo "ðŸ“ Found $YAML_COUNT YAML file(s) to process"

        if [[ $YAML_COUNT -eq 0 ]]; then
          echo "âš ï¸  No YAML files found in ${{ inputs.yaml_input_path }}"
          echo "Please ensure the directory contains .yaml or .yml files"
          exit 1
        fi

    - name: Enhance YAML Files
      if: steps.should-process.outputs.should_process == 'true'
      id: enhance
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        OPENAI_MODEL: ${{ inputs.openai_model }}
        YAML_INPUT_PATH: ${{ inputs.yaml_input_path }}
        YAML_OUTPUT_PATH: ${{ inputs.yaml_output_path }}
        ENHANCEMENT_MODE: ${{ inputs.enhancement_mode }}
        QUALITY_THRESHOLD: ${{ inputs.quality_threshold }}
        MAX_ITERATIONS: ${{ inputs.max_iterations }}
        COMPLETENESS_THRESHOLD: ${{ inputs.completeness_threshold }}
        TIMEOUT_MINUTES: ${{ inputs.timeout_minutes }}
        PROCESS_CHANGED_ONLY: ${{ inputs.process_changed_only }}
        CHANGED_FILES: ${{ inputs.changed_files || steps.changed-yaml.outputs.changed_files }}
      run: |
        echo "ðŸš€ Starting YAML enhancement..."
        echo "ðŸ“ Input: ${{ inputs.yaml_input_path }}"
        echo "ðŸ“„ Output: ${{ inputs.yaml_output_path || 'in-place' }}"
        echo "ðŸ¤– AI Model: ${{ inputs.openai_model }}"
        echo "ðŸŽ¯ Quality Threshold: ${{ inputs.quality_threshold }}%"

        # Run the YAML enhancer
        python "${{ github.action_path }}/src/yaml_enhancer_main.py"

        # Determine output path for counting
        OUTPUT_DIR="${{ inputs.yaml_output_path }}"
        if [[ -z "$OUTPUT_DIR" ]]; then
          OUTPUT_DIR="${{ inputs.yaml_input_path }}"
        fi

        # Count enhanced files
        FILES_COUNT=$(find "$OUTPUT_DIR" -name "*.yaml" -o -name "*.yml" | wc -l)
        echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
        echo "output_path=$OUTPUT_DIR" >> $GITHUB_OUTPUT

        # Extract enhancements total from enhancement summary (if available)
        if [[ -n "$ENHANCEMENTS_TOTAL" ]]; then
          echo "enhancements_total=$ENHANCEMENTS_TOTAL" >> $GITHUB_OUTPUT
        else
          echo "enhancements_total=0" >> $GITHUB_OUTPUT
        fi

        echo "âœ… Enhanced $FILES_COUNT YAML file(s)"

    - name: Create Pull Request
      if: inputs.create_pull_request == 'true' && steps.should-process.outputs.should_process == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ github.token }}
        commit-message: 'ðŸ“ Enhance OpenAPI YAML specifications with AI-generated descriptions'
        title: ${{ env.GENERATED_PR_TITLE || inputs.pr_title }}
        body: |
          ## ðŸ“ YAML Enhancements

          This PR enhances OpenAPI YAML specifications with AI-generated descriptions.

          ### ðŸ“Š Enhancement Summary
          - **Files enhanced:** ${{ steps.enhance.outputs.files_count }}
          - **Total enhancements:** ${{ steps.enhance.outputs.enhancements_total }}
          - **Enhancement mode:** ${{ inputs.enhancement_mode }}
          - **AI Model Used:** ${{ inputs.openai_model }}

          ### ðŸŽ¯ What was enhanced
          - Missing info.description fields
          - Parameter descriptions
          - Schema descriptions
          - Property descriptions
          - Tag descriptions

          ### ðŸ”„ Process Details
          - **Max Iterations:** ${{ inputs.max_iterations }}
          - **Quality Threshold:** ${{ inputs.quality_threshold }}%
          - **Processing Time Limit:** ${{ inputs.timeout_minutes }} minutes
          - **Change Detection:** ${{ inputs.process_changed_only == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}

          All enhancements preserve the original YAML structure, comments, and formatting.

          ---
          ðŸ¤– Generated with AI using ${{ inputs.openai_model }}

          Please review the enhanced YAML specifications before merging.
        branch: ${{ inputs.pr_branch_name }}
        branch-suffix: timestamp
        delete-branch: true
        add-paths: |
          ${{ inputs.yaml_output_path || inputs.yaml_input_path }}/**
        assignees: ${{ github.actor }}

    - name: Summary
      if: steps.should-process.outputs.should_process == 'true'
      shell: bash
      run: |
        echo "## ðŸ“ YAML Enhancement Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **AI Model Used:** ${{ inputs.openai_model }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Enhancement Mode:** ${{ inputs.enhancement_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Quality Threshold:** ${{ inputs.quality_threshold }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.create_pull_request }}" == "true" ]; then
          echo "### ðŸŒ¿ Pull Request Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** Auto-generated with timestamp" >> $GITHUB_STEP_SUMMARY
          echo "- **Assignee:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Ready for review" >> $GITHUB_STEP_SUMMARY
        else
          # Determine output directory
          OUTPUT_DIR="${{ inputs.yaml_output_path }}"
          if [[ -z "$OUTPUT_DIR" ]]; then
            OUTPUT_DIR="${{ inputs.yaml_input_path }}"
          fi

          # Count files if output directory exists
          if [[ -d "$OUTPUT_DIR" ]]; then
            FILES_COUNT=$(find "$OUTPUT_DIR" -name "*.yaml" -o -name "*.yml" 2>/dev/null | wc -l)
            echo "- **Files Enhanced:** $FILES_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Enhanced Files:" >> $GITHUB_STEP_SUMMARY
            if [[ $FILES_COUNT -gt 0 ]]; then
              find "$OUTPUT_DIR" -name "*.yaml" -o -name "*.yml" 2>/dev/null | while read file; do
                echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
              done
            fi
          fi
        fi
