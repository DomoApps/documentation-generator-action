# Apache License
# Version 2.0, January 2004
# Author: Jonathan Tiritilli

name: 'YAML to Markdown Documentation Generator'
description: 'Generate professional markdown documentation from YAML files using AI with iterative refinement'
author: 'Jonathan Tiritilli'
branding:
  icon: user-minus
  color: yellow

inputs:
  openai_api_key:
    description: 'OpenAI API key for AI processing'
    required: true
  yaml_input_path:
    description: 'Path to directory containing YAML files'
    required: false
    default: './yaml'
  output_path:
    description: 'Path to output directory for generated documentation'
    required: false
    default: './docs'
  template_path:
    description: 'Path to Handlebars template file'
    required: false
    default: 'default'
  openai_model:
    description: 'OpenAI model to use (gpt-4o, gpt-4, gpt-3.5-turbo)'
    required: false
    default: 'gpt-4o'
  max_iterations:
    description: 'Maximum refinement iterations'
    required: false
    default: '3'
  completeness_threshold:
    description: 'Quality score threshold for completion (0-100)'
    required: false
    default: '90'
  timeout_minutes:
    description: 'Maximum processing time in minutes'
    required: false
    default: '30'
  process_changed_only:
    description: 'Only process YAML files that have changed (requires git history)'
    required: false
    default: 'false'
  changed_files:
    description: 'Newline-separated list of changed files to process (overrides internal change detection)'
    required: false
    default: ''
  base_ref:
    description: 'Base reference for change detection (default: main branch or PR base)'
    required: false
    default: ''
  create_pull_request:
    description: 'Create a pull request with generated documentation'
    required: false
    default: 'false'
  pr_title:
    description: 'Title for the pull request'
    required: false
    default: 'üìö Update API Documentation'
  pr_branch_name:
    description: 'Name for the PR branch (uses auto-generated name if not provided)'
    required: false
    default: 'docs/update-api-docs'
  pr_branch_prefix:
    description: 'Branch name prefix for individual PRs (e.g., "doc-bot" creates branches like "doc-bot/filename")'
    required: false
    default: 'doc-bot'
  create_individual_prs:
    description: 'Create individual PRs for each changed file instead of one PR for all changes'
    required: false
    default: 'false'
  prevent_duplicate_prs:
    description: 'Check for existing PRs before creating new ones (only applies when create_individual_prs is true)'
    required: false
    default: 'true'
  base_branch:
    description: 'Base branch to create PRs from (e.g., master, main)'
    required: false
    default: 'master'

outputs:
  documentation_path:
    description: 'Path to generated documentation directory'
    value: ${{ steps.generate.outputs.output_path }}
  files_generated:
    description: 'Number of markdown files generated'
    value: ${{ steps.generate.outputs.files_count }}

runs:
  using: composite
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r ${{ github.action_path }}/requirements.txt

    - name: Detect changed YAML files
      id: changed-yaml
      shell: bash
      run: |
        if [[ "${{ inputs.process_changed_only }}" == "true" ]]; then
          echo "üîç Detecting changed YAML files..."

          # Determine base reference
          if [[ -n "${{ inputs.base_ref }}" ]]; then
            BASE_REF="${{ inputs.base_ref }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            # For direct pushes to main, compare against previous commit
            BASE_REF="${{ github.event.before }}"
          else
            BASE_REF="origin/main"
          fi

          echo "Base reference: $BASE_REF"

          # Get changed YAML files
          YAML_DIR=$(echo "${{ inputs.yaml_input_path }}" | sed 's|^\./||')  # Remove leading ./
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT "$BASE_REF"...HEAD | grep -E '\.(yaml|yml)$' | grep "^${YAML_DIR}/" || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "‚ö†Ô∏è No YAML files changed in ${{ inputs.yaml_input_path }}"
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed YAML files:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'

          # Save to output
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "üóÇÔ∏è Processing all YAML files in directory"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files=" >> $GITHUB_OUTPUT
        fi

    - name: Filter files with existing PRs
      id: filter-prs
      if: inputs.create_individual_prs == 'true' && inputs.prevent_duplicate_prs == 'true'
      shell: bash
      env:
        CHANGED_FILES: ${{ inputs.changed_files || steps.changed-yaml.outputs.changed_files }}
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üîç Checking for existing PRs..."

        FILES_TO_PROCESS=""
        SKIPPED_COUNT=0
        TOTAL_COUNT=0

        if [[ -n "$CHANGED_FILES" ]]; then
          # Use process substitution to avoid subshell issue
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            TOTAL_COUNT=$((TOTAL_COUNT + 1))

            FILE_NAME=$(basename "$file")
            FILE_BASE="${FILE_NAME%.*}"
            BRANCH_NAME="${{ inputs.pr_branch_prefix }}/$FILE_BASE"

            # Check if PR already exists for this branch
            if gh pr list --state open --head "$BRANCH_NAME" --json number,title --jq '.[0].number' 2>/dev/null | grep -q .; then
              PR_NUM=$(gh pr list --state open --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "unknown")
              echo "‚è≠Ô∏è Skipping $FILE_NAME (PR #$PR_NUM already exists for branch: $BRANCH_NAME)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            else
              echo "‚úÖ Will process $FILE_NAME (no existing PR for branch: $BRANCH_NAME)"
              FILES_TO_PROCESS="${FILES_TO_PROCESS}${file}"$'\n'
            fi
          done < <(echo "$CHANGED_FILES")
        fi

        echo ""
        echo "Summary: Total=$TOTAL_COUNT, Skipped=$SKIPPED_COUNT, ToProcess=$((TOTAL_COUNT - SKIPPED_COUNT))"

        # Remove trailing newline
        FILES_TO_PROCESS=$(echo "$FILES_TO_PROCESS" | sed '/^$/d')

        if [[ -z "$FILES_TO_PROCESS" ]]; then
          echo "‚ö†Ô∏è All files already have open PRs, nothing to process"
          echo "files_to_process=" >> $GITHUB_OUTPUT
          echo "has_files_to_process=false" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
        else
          echo "üìù Files to process:"
          echo "$FILES_TO_PROCESS" | sed 's/^/  - /'

          echo "files_to_process<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES_TO_PROCESS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_files_to_process=true" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
        fi

    - name: Check if processing needed
      id: should-process
      shell: bash
      run: |
        # Determine if we should continue processing
        if [[ "${{ inputs.create_individual_prs }}" == "true" && "${{ inputs.prevent_duplicate_prs }}" == "true" ]]; then
          # For individual PRs with duplicate prevention, check if any files need processing
          if [[ "${{ steps.filter-prs.outputs.has_files_to_process }}" != "true" ]]; then
            echo "‚ÑπÔ∏è All files have existing PRs, no processing needed"
            echo "## ‚ÑπÔ∏è No Processing Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All changed files already have open pull requests." >> $GITHUB_STEP_SUMMARY
            echo "Skipped ${{ steps.filter-prs.outputs.skipped_count }} file(s) with existing PRs." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action taken:** Workflow completed successfully without generating new documentation." >> $GITHUB_STEP_SUMMARY
            echo "should_process=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi

        # Check if there are any changes to process
        # Use external changed_files input if provided, otherwise check internal detection
        if [[ -n "${{ inputs.changed_files }}" ]]; then
          # External file list provided - always process
          echo "should_process=true" >> $GITHUB_OUTPUT
        elif [[ "${{ steps.changed-yaml.outputs.has_changes }}" != "true" ]]; then
          echo "‚ÑπÔ∏è No changes detected, no processing needed"
          echo "## ‚ÑπÔ∏è No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No YAML files have changed since last run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action taken:** Workflow completed successfully without generating documentation." >> $GITHUB_STEP_SUMMARY
          echo "should_process=false" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "should_process=true" >> $GITHUB_OUTPUT
        fi

    - name: Prepare directories and template
      if: steps.should-process.outputs.should_process == 'true'
      shell: bash
      run: |
        # Create output directory
        mkdir -p "${{ inputs.output_path }}"

        # Set up template
        if [[ "${{ inputs.template_path }}" == "default" ]]; then
          mkdir -p templates
          cp "${{ github.action_path }}/templates/product-api.template.md" templates/
          TEMPLATE_PATH="./templates/product-api.template.md"
        else
          TEMPLATE_PATH="${{ inputs.template_path }}"
        fi
        echo "TEMPLATE_PATH=$TEMPLATE_PATH" >> $GITHUB_ENV

        # Verify input directory exists
        if [[ ! -d "${{ inputs.yaml_input_path }}" ]]; then
          echo "‚ùå Input directory not found: ${{ inputs.yaml_input_path }}"
          echo "Please ensure YAML files are in the specified directory"
          exit 1
        fi

        # Count YAML files
        YAML_COUNT=$(find "${{ inputs.yaml_input_path }}" -name "*.yaml" -o -name "*.yml" | wc -l)
        echo "üìÅ Found $YAML_COUNT YAML file(s) to process"

        if [[ $YAML_COUNT -eq 0 ]]; then
          echo "‚ö†Ô∏è  No YAML files found in ${{ inputs.yaml_input_path }}"
          echo "Please ensure the directory contains .yaml or .yml files"
          exit 1
        fi

    - name: Generate Documentation
      if: steps.should-process.outputs.should_process == 'true' && inputs.create_individual_prs != 'true'
      id: generate
      shell: bash
      env:
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        OPENAI_MODEL: ${{ inputs.openai_model }}
        YAML_INPUT_PATH: ${{ inputs.yaml_input_path }}
        MARKDOWN_OUTPUT_PATH: ${{ inputs.output_path }}
        TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
        MAX_ITERATIONS: ${{ inputs.max_iterations }}
        COMPLETENESS_THRESHOLD: ${{ inputs.completeness_threshold }}
        TIMEOUT_MINUTES: ${{ inputs.timeout_minutes }}
        PROCESS_CHANGED_ONLY: ${{ inputs.process_changed_only }}
        CHANGED_FILES: ${{ inputs.create_individual_prs == 'true' && steps.filter-prs.outputs.files_to_process || steps.changed-yaml.outputs.changed_files }}
      run: |
        echo "üöÄ Starting documentation generation..."
        echo "üìÅ Input: ${{ inputs.yaml_input_path }}"
        echo "üìÑ Output: ${{ inputs.output_path }}"
        echo "üé® Template: $TEMPLATE_PATH"
        echo "ü§ñ AI Model: ${{ inputs.openai_model }}"

        if [[ "${{ inputs.create_individual_prs }}" == "true" && "${{ steps.filter-prs.outputs.skipped_count }}" != "0" ]]; then
          echo "‚è≠Ô∏è Skipped ${{ steps.filter-prs.outputs.skipped_count }} file(s) with existing PRs"
        fi

        # Run the documentation generator
        python "${{ github.action_path }}/src/doc_generator_main.py"

        # Count generated files
        FILES_COUNT=$(find "${{ inputs.output_path }}" -name "*.md" | wc -l)
        echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
        echo "output_path=${{ inputs.output_path }}" >> $GITHUB_OUTPUT

        echo "‚úÖ Generated $FILES_COUNT markdown file(s)"

    - name: Create Individual Pull Requests
      id: create-individual-prs
      if: inputs.create_pull_request == 'true' && inputs.create_individual_prs == 'true' && steps.should-process.outputs.should_process == 'true'
      shell: bash
      env:
        FILES_TO_PROCESS: ${{ steps.filter-prs.outputs.files_to_process }}
        GH_TOKEN: ${{ github.token }}
        OPENAI_API_KEY: ${{ inputs.openai_api_key }}
        OPENAI_MODEL: ${{ inputs.openai_model }}
        TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
        MAX_ITERATIONS: ${{ inputs.max_iterations }}
        COMPLETENESS_THRESHOLD: ${{ inputs.completeness_threshold }}
        TIMEOUT_MINUTES: ${{ inputs.timeout_minutes }}
      run: |
        echo "üìÑ Creating individual PRs (one file at a time)..."

        PROCESSED=0
        FAILED=0
        BASE_BRANCH="${{ inputs.base_branch }}"
        OUTPUT_DIR="${{ inputs.output_path }}"
        PR_URLS=""

        if [[ -n "$FILES_TO_PROCESS" ]]; then
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue

            FILE_NAME=$(basename "$file")
            FILE_BASE="${FILE_NAME%.*}"
            BRANCH_NAME="${{ inputs.pr_branch_prefix }}/$FILE_BASE"
            MD_FILE="${OUTPUT_DIR}/${FILE_BASE}.md"

            echo "---"
            echo "Processing: $FILE_NAME"
            echo "Branch: $BRANCH_NAME"

            # Create/checkout branch first
            git fetch origin 2>/dev/null || true

            # Ensure we're on the base branch
            git checkout "$BASE_BRANCH" 2>/dev/null || true

            # Check if branch exists remotely
            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "Branch exists remotely, checking out..."
              git checkout "$BRANCH_NAME" 2>/dev/null || git checkout -b "$BRANCH_NAME" "origin/$BRANCH_NAME"
              git pull origin "$BRANCH_NAME" || true
            else
              echo "Creating new branch..."
              git checkout -b "$BRANCH_NAME" || {
                echo "‚ùå Failed to create branch $BRANCH_NAME"
                FAILED=$((FAILED + 1))
                continue
              }
            fi

            # Now generate documentation for THIS file only on THIS branch
            echo "Generating documentation for $FILE_NAME..."
            mkdir -p "$OUTPUT_DIR"

            # Run the doc generator for this single file using changed_files mechanism
            CHANGED_FILES="$file" \
            MARKDOWN_OUTPUT_PATH="$OUTPUT_DIR" \
            PROCESS_CHANGED_ONLY="true" \
            python "${{ github.action_path }}/src/doc_generator_main.py" || {
              echo "‚ùå Documentation generation failed for $FILE_NAME"
              git checkout "$BASE_BRANCH" 2>/dev/null || true
              FAILED=$((FAILED + 1))
              continue
            }

            # Check if file was generated
            if [[ ! -f "$MD_FILE" ]]; then
              echo "‚ùå Generated file not found: $MD_FILE"
              git checkout "$BASE_BRANCH" 2>/dev/null || true
              FAILED=$((FAILED + 1))
              continue
            fi

            # Stage changes
            git add "$MD_FILE"

            # Check if there are changes to commit
            if [[ -z $(git diff --cached --name-only) ]]; then
              echo "‚ÑπÔ∏è No changes to commit for $FILE_NAME"
              git checkout "$BASE_BRANCH" 2>/dev/null || true
              continue
            fi

            # Commit
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            if ! git commit -m "üìö Update documentation for $FILE_NAME" -m "Auto-generated from YAML specification" -m "Source: $file"; then
              echo "‚ö†Ô∏è Commit failed for $FILE_NAME"
              git checkout "$BASE_BRANCH" 2>/dev/null || true
              FAILED=$((FAILED + 1))
              continue
            fi

            # Push
            if ! git push -f origin "$BRANCH_NAME"; then
              echo "‚ùå Push failed for $FILE_NAME"
              git checkout "$BASE_BRANCH" 2>/dev/null || true
              FAILED=$((FAILED + 1))
              continue
            fi

            # Create or update PR (only if there's an OPEN PR)
            PR_STATE=$(gh pr view "$BRANCH_NAME" --json state --jq '.state' 2>/dev/null || echo "")
            if [[ "$PR_STATE" == "OPEN" ]]; then
              PR_URL=$(gh pr view "$BRANCH_NAME" --json url --jq '.url')
              echo "‚úÖ Updated existing PR for $FILE_NAME: $PR_URL"
              PR_URLS="${PR_URLS}${FILE_NAME}|${PR_URL}"$'\n'
              PROCESSED=$((PROCESSED + 1))
            else
              PR_URL=$(gh pr create \
                --title "üìö Update documentation for $FILE_NAME" \
                --body "## ü§ñ Auto-Generated Documentation Update

        This PR contains automatically generated documentation for a single file.

        ### üìä File Details
        - **Source File:** \`$file\`
        - **Generated File:** \`$MD_FILE\`
        - **AI Model Used:** ${{ inputs.openai_model }}

        ### üîÑ Process Details
        - **Max Iterations:** ${{ inputs.max_iterations }}
        - **Quality Threshold:** ${{ inputs.completeness_threshold }}%

        ---
        ü§ñ This PR was created automatically by the YAML to Markdown Documentation Generator.

        Please review the generated documentation before merging." \
                --assignee "${{ github.actor }}" \
                --head "$BRANCH_NAME" \
                --base "$BASE_BRANCH" 2>&1)

              if [[ $PR_URL == https://* ]]; then
                echo "‚úÖ Created PR for $FILE_NAME: $PR_URL"
                PR_URLS="${PR_URLS}${FILE_NAME}|${PR_URL}"$'\n'
                PROCESSED=$((PROCESSED + 1))
              else
                echo "‚ö†Ô∏è PR creation failed for $FILE_NAME"
                FAILED=$((FAILED + 1))
              fi
            fi

            # Return to base branch
            git checkout "$BASE_BRANCH" 2>/dev/null || true
          done < <(echo "$FILES_TO_PROCESS")

          echo ""
          echo "üìä Individual PR Summary:"
          echo "- Processed: $PROCESSED"
          echo "- Failed: $FAILED"

          # Save PR URLs to output for summary step
          echo "PR_URLS<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è No files to process"
        fi

    - name: Create Single Pull Request
      if: inputs.create_pull_request == 'true' && inputs.create_individual_prs != 'true' && steps.should-process.outputs.should_process == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ github.token }}
        commit-message: 'üìö Generate API documentation from YAML specifications'
        title: ${{ env.GENERATED_PR_TITLE || inputs.pr_title }}
        body: |
          ## ü§ñ Auto-generated Documentation Update

          This pull request contains automatically generated documentation from YAML specifications.

          ### üìä Generation Summary
          - **Input Directory:** `${{ inputs.yaml_input_path }}`
          - **Output Directory:** `${{ inputs.output_path }}`
          - **AI Model Used:** ${{ inputs.openai_model }}
          - **Files Generated:** ${{ steps.generate.outputs.files_count }}
          - **Smart Title:** AI-generated based on content analysis

          ### üîÑ Process Details
          - **Max Iterations:** ${{ inputs.max_iterations }}
          - **Quality Threshold:** ${{ inputs.completeness_threshold }}%
          - **Processing Time Limit:** ${{ inputs.timeout_minutes }} minutes
          - **Change Detection:** ${{ inputs.process_changed_only == 'true' && '‚úÖ Enabled' || '‚ùå Disabled' }}

          ---
          ü§ñ This PR was created automatically by the YAML to Markdown Documentation Generator.

          Please review the generated documentation before merging.
        branch: ${{ inputs.pr_branch_name }}
        branch-suffix: timestamp
        delete-branch: true
        add-paths: |
          ${{ inputs.output_path }}/**
        assignees: ${{ github.actor }}

    - name: Summary
      if: steps.should-process.outputs.should_process == 'true'
      shell: bash
      run: |
        echo "## üìö Documentation Generation Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **AI Model Used:** ${{ inputs.openai_model }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Template:** ${{ env.TEMPLATE_PATH }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.create_individual_prs }}" == "true" ]; then
          echo "### üåø Individual Pull Requests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PR_URLS="${{ steps.create-individual-prs.outputs.PR_URLS }}"
          if [[ -n "$PR_URLS" ]]; then
            while IFS='|' read -r filename url; do
              [[ -z "$filename" ]] && continue
              echo "- **$filename**: $url" >> $GITHUB_STEP_SUMMARY
            done <<< "$PR_URLS"
          else
            echo "- No PRs created" >> $GITHUB_STEP_SUMMARY
          fi
        elif [ "${{ inputs.create_pull_request }}" == "true" ]; then
          echo "### üåø Pull Request Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** Auto-generated with timestamp" >> $GITHUB_STEP_SUMMARY
          echo "- **Assignee:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Ready for review" >> $GITHUB_STEP_SUMMARY
        else
          # Count files if output directory exists
          if [[ -d "${{ inputs.output_path }}" ]]; then
            FILES_COUNT=$(find "${{ inputs.output_path }}" -name "*.md" 2>/dev/null | wc -l)
            echo "- **Files Generated:** $FILES_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
            if [[ $FILES_COUNT -gt 0 ]]; then
              find "${{ inputs.output_path }}" -name "*.md" 2>/dev/null | while read file; do
                echo "- \`$(basename "$file")\`" >> $GITHUB_STEP_SUMMARY
              done
            fi
          fi
        fi
