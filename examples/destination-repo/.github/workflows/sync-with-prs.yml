# Sync OpenAPI Specifications with Individual PRs
#
# Creates individual PRs for each changed YAML file for review.
# Use with update-navigation-on-merge.yml to update docs.json when PRs merge.

name: Sync OpenAPI Specs (with PRs)

# ============================================================================
# CONFIGURATION - Update these values for your setup
# ============================================================================
env:
  # Source repository (where OpenAPI YAMLs live)
  SOURCE_OWNER: domoinc
  SOURCE_REPO: internal-domo-apis
  SOURCE_YAML_PATH: api-docs/public

  # Destination paths (in this repo)
  DEST_YAML_PATH: openapi/product
  DEST_REPO: DomoApps/domo-developer-portal

  # Git settings
  BASE_BRANCH: master
  PR_BRANCH_PREFIX: openapi-sync
# ============================================================================

on:
  schedule:
    - cron: "0 */6 * * *"

  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync all YAML files"
        required: false
        type: boolean
        default: false

  repository_dispatch:
    types: [openapi-updated]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ env.SOURCE_OWNER }}
          repositories: ${{ env.SOURCE_REPO }}

      - name: Checkout Destination Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Source Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_OWNER }}/${{ env.SOURCE_REPO }}
          token: ${{ steps.app-token.outputs.token }}
          path: source-repo
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Detect Changed YAML Files
        id: detect
        run: |
          python .github/scripts/detect_yaml_changes.py \
            --source "source-repo/${{ env.SOURCE_YAML_PATH }}" \
            --dest "${{ env.DEST_YAML_PATH }}" \
            --force ${{ github.event.inputs.force_sync || 'false' }}

      - name: Check for Changes
        id: check
        run: |
          if [ -f changed_files.txt ] && [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Individual PRs
        if: steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python .github/scripts/create_individual_prs.py \
            --changed-list changed_files.txt \
            --source-dir "source-repo/${{ env.SOURCE_YAML_PATH }}" \
            --dest-dir "${{ env.DEST_YAML_PATH }}" \
            --base-branch "${{ env.BASE_BRANCH }}" \
            --pr-branch-prefix "${{ env.PR_BRANCH_PREFIX }}" \
            --repo "${{ env.DEST_REPO }}"

      - name: Summary
        if: always()
        run: |
          echo "## OpenAPI Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
            echo "Individual PRs created for:" >> $GITHUB_STEP_SUMMARY
            if [ -f changed_files.txt ]; then
              while IFS= read -r file; do
                echo "- \`$(basename $file)\`" >> $GITHUB_STEP_SUMMARY
              done < changed_files.txt
            fi
          else
            echo "No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
