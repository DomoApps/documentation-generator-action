name: Sync API Documentation from Source Repo

# This workflow runs autonomously in the destination repo - NO secrets needed in source repo!
# It can be triggered three ways:
# 1. Schedule: Runs every 6 hours, checks source repo for changes
# 2. Manual: Use workflow_dispatch to run on demand
# 3. Source notification: Optional repository_dispatch from source repo (requires source repo secrets)

on:
  # Primary trigger - runs automatically every 6 hours
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

  # Manual trigger - use this for on-demand sync
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all docs (ignore change detection)'
        required: false
        type: boolean
        default: false

  # Optional - only works if source repo has APP_ID and APP_PRIVATE_KEY secrets configured
  repository_dispatch:
    types: [source-yaml-updated]

jobs:
  sync_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: domoinc
          repositories: internal-domo-apis

      - name: Checkout Destination Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Source Repo
        uses: actions/checkout@v4
        with:
          repository: domoinc/internal-domo-apis
          token: ${{ steps.app-token.outputs.token }}
          path: source-repo
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      # Cross-repo change detection: Compare source YAML timestamps with destination markdown
      # This is needed because we're syncing between two repos - git diff wouldn't detect these changes
      - name: Detect Changed YAML Files
        id: detect
        run: |
          python .github/scripts/detect_yaml_changes.py \
            --source source-repo/api-docs/public \
            --dest docs/API-Reference/Product-APIs \
            --mapping .github/doc-mapping.json \
            --force ${{ github.event.inputs.force_regenerate || 'false' }}

      - name: Check if Changes Detected
        id: check
        run: |
          if [ -f changed_files.txt ] && [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files detected:"
            cat changed_files.txt
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      # Process each changed file individually to create separate PRs
      - name: Process Changed Files Individually
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # Initialize counters
          TOTAL_FILES=0
          PROCESSED_FILES=0
          SKIPPED_FILES=0
          FAILED_FILES=0

          echo "## Processing Files Individually" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Process each file
          while IFS= read -r file; do
            TOTAL_FILES=$((TOTAL_FILES + 1))

            if [ ! -f "$file" ]; then
              echo "âš ï¸ File not found: $file" | tee -a $GITHUB_STEP_SUMMARY
              FAILED_FILES=$((FAILED_FILES + 1))
              continue
            fi

            FILE_NAME=$(basename "$file")
            FILE_BASE="${FILE_NAME%.*}"
            BRANCH_NAME="docs/sync-api-docs-$FILE_BASE"

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“„ Processing: $FILE_NAME" >> $GITHUB_STEP_SUMMARY

            # Check if PR already exists for this file
            if python .github/scripts/check_existing_prs.py \
                --file-name "$FILE_NAME" \
                --branch-prefix "docs/sync-api-docs" \
                --output-format text; then

              echo "âœ… Creating new PR for $FILE_NAME"
              echo "- **Status:** Creating new PR" >> $GITHUB_STEP_SUMMARY

              # Create temporary directory for this file only
              mkdir -p "./temp-yaml-$FILE_BASE"
              cp "$file" "./temp-yaml-$FILE_BASE/"

              # Create temporary output directory
              mkdir -p "./temp-docs-$FILE_BASE"

              # Set environment variables for the action
              export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
              export YAML_INPUT_PATH="./temp-yaml-$FILE_BASE"
              export MARKDOWN_OUTPUT_PATH="./temp-docs-$FILE_BASE"
              export TEMPLATE_PATH="./templates/product-api.template.md"
              export OPENAI_MODEL="gpt-4o"
              export PROCESS_CHANGED_ONLY="false"

              # Run the doc generator
              python -m pip install -q openai pyyaml prance jsonschema 2>/dev/null || true
              python << 'PYEOF' || {
                echo "âŒ Failed to generate docs for $FILE_NAME" | tee -a $GITHUB_STEP_SUMMARY
                FAILED_FILES=$((FAILED_FILES + 1))
                rm -rf "./temp-yaml-$FILE_BASE" "./temp-docs-$FILE_BASE"
                continue
              }
          import sys
          import os
          sys.path.insert(0, '${{ github.action_path }}/src')

          # Import and run the main function
          from doc_generator_main import main
          main()
          PYEOF

              # Sync to destination (create file list with just this file)
              echo "$file" > "./temp-changed-$FILE_BASE.txt"

              python .github/scripts/sync_to_destination.py \
                --generated "./temp-docs-$FILE_BASE" \
                --destination "docs/API-Reference/Product-APIs" \
                --mapping .github/doc-mapping.json \
                --changed-list "./temp-changed-$FILE_BASE.txt" || {
                  echo "âŒ Failed to sync $FILE_NAME" | tee -a $GITHUB_STEP_SUMMARY
                  FAILED_FILES=$((FAILED_FILES + 1))
                  rm -rf "./temp-yaml-$FILE_BASE" "./temp-docs-$FILE_BASE" "./temp-changed-$FILE_BASE.txt"
                  continue
                }

              # Check if there are changes to commit
              if [[ -n $(git status --porcelain docs/API-Reference/Product-APIs .github/doc-mapping.json 2>/dev/null) ]]; then
                # Checkout or create branch
                git fetch origin
                if git rev-parse --verify "origin/$BRANCH_NAME" >/dev/null 2>&1; then
                  git checkout "$BRANCH_NAME"
                  git pull origin "$BRANCH_NAME"
                else
                  git checkout -b "$BRANCH_NAME"
                fi

                # Stage changes
                git add docs/API-Reference/Product-APIs
                git add .github/doc-mapping.json 2>/dev/null || true

                # Commit changes
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"

                git commit -m "ðŸ“š Sync documentation for $FILE_NAME" -m "Auto-generated from source repository." -m "Source file: $file"

                # Push changes
                git push -f origin "$BRANCH_NAME"

                # Create or update PR using GitHub CLI
                if gh pr view "$BRANCH_NAME" --json number >/dev/null 2>&1; then
                  echo "- **Result:** ðŸ”„ Updated existing PR" >> $GITHUB_STEP_SUMMARY
                  PROCESSED_FILES=$((PROCESSED_FILES + 1))
                else
                  gh pr create \
                    --title "ðŸ“š Sync documentation for $FILE_NAME" \
                    --body "## ðŸ¤– Auto-Generated Documentation Sync

          This PR contains automatically synchronized API documentation for a single file.

          ### ðŸ“Š File Details
          - **Source File:** \`$file\`
          - **Generated File:** \`$FILE_NAME\`
          - **Source Repository:** \`domoinc/internal-domo-apis\`

          ### âœ… Actions Taken
          - Detected changes in source YAML file
          - Generated markdown documentation using AI
          - Synced to destination path
          - Updated mapping configuration (if needed)

          ---
          ðŸ¤– This PR was created automatically by the sync-api-docs workflow.

          Please review the generated documentation before merging." \
                    --assignee "${{ github.actor }}" \
                    --head "$BRANCH_NAME" \
                    --base main && {
                      echo "- **Result:** âœ… PR created successfully" >> $GITHUB_STEP_SUMMARY
                      PROCESSED_FILES=$((PROCESSED_FILES + 1))
                    } || {
                      echo "- **Result:** âš ï¸ PR creation failed (might already exist)" >> $GITHUB_STEP_SUMMARY
                    }
                fi

                # Return to main branch
                git checkout main
              else
                echo "- **Result:** â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
                SKIPPED_FILES=$((SKIPPED_FILES + 1))
              fi

              # Cleanup
              rm -rf "./temp-yaml-$FILE_BASE" "./temp-docs-$FILE_BASE" "./temp-changed-$FILE_BASE.txt"

            else
              echo "â­ï¸ Skipping $FILE_NAME - PR already exists"
              echo "- **Status:** â­ï¸ Skipped (PR already exists)" >> $GITHUB_STEP_SUMMARY
              SKIPPED_FILES=$((SKIPPED_FILES + 1))
            fi

          done < changed_files.txt

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Files:** $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Processed (PRs created/updated):** $PROCESSED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped (existing PRs):** $SKIPPED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_FILES" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Changes detected and processed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changed Files:" >> $GITHUB_STEP_SUMMARY
            if [ -f changed_files.txt ]; then
              while IFS= read -r file; do
                echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
              done < changed_files.txt
            fi
          else
            echo "â„¹ï¸ No changes detected - documentation is up to date" >> $GITHUB_STEP_SUMMARY
          fi
